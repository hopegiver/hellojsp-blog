<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>

<script>

	var menuData = [];
	var treeMenu = null;
	
	$(function(){
		$(window).on("load",function(){
	        $(".treeBox").mCustomScrollbar();
	    });
		
		var parent = {id:'0', parent:'#', text:'메뉴 권한', sort: '0', menuDepth: '0', useYn: 'Y'};
		menuData = ${menuInfo};
		menuData.push(parent);
		
		$("#menuSelect-dialog").dialog({
			draggable: true,
	        resizable: false,
	        width: 450,
	        height: 500,
	        autoOpen: false,
		    open: function (event, ui) {
		    	fixDialogHeight("#menuSelect-dialog");
		        //$(".ui-widget-overlay").css({display:"block"});
		        setMenuNodeUse();
		    },
		    close: function (event, ui) {
		    	$(this).mCustomScrollbar('destroy');
		        //$(".ui-widget-overlay").css({display:"none"});
		   	},
		    buttons: [
		    	{text: "선택", click: selectMenu},
		    	{text: "닫기", click: closePop}
	    	]
		});
		
		$('#treeBox').jstree({
      		'core' : {
      	    	"check_callback" : true,
      	    	"opened" : true,
      	    	"selected" : true,
      	    	"data" : menuData,
      		},
      		"plugins" : [ "sort" ],
      		"sort" : function(a, b) {
      			var a1 = getMenuData(a);
      	        var b1 = getMenuData(b);
      	        if(a1 != null && b1 != null)
	      	        return a1.menuDepth >= b1.menuDepth && a1.sort >= b1.sort;
      	        if(a1 != null)
      	        	return true;
      	        return false;
      	    }
      	});
		
		$('#treeBox').on("load_node.jstree", function (event, data) {
			$(this).jstree("open_all");
	    });
		
		$(document).on('dblclick', '#treeBox .jstree-clicked', selectMenu);

		treeMenu = $('#treeBox').jstree(true);
	});

	function getMenuData(id){
		for(var i = 0; i < menuData.length; i++){
			if(menuData[i].id == id)
				return menuData[i];
        }
		return null;
	}
	
	function closePop(){
		$("#menuSelect-dialog").dialog('close');
	}
	
	function openMenuSelect(flag, userId){
		$('#flag').val(flag);
		
		treeMenu.deselect_all();
		treeMenu.open_all();
		if(userId != null && userId != ''){
			treeMenu.select_node(userId);
		}
		
		$("#menuSelect-dialog").dialog('open');
	}
	
	function selectMenu(){
		var flag = $('#flag').val();
		if(flag == 'Create'){
			changeMenuActionCreate();
		}
		else if(flag =='Update'){
			changeMenuActionUpdate();
		}
		$("#menuSelect-dialog").dialog('close');
	}
	
	function getSelectedMenuNode(){
		var sel = treeMenu.get_selected();
		if(!sel.length)
			return null;
		
		return treeMenu.get_node(sel[0]);
	}
	
	function setMenuNodeUse(){
		for(var i = 0; i < menuData.length; i++){
			if(menuData[i].id != 0){
				var tag = $("#treeBox #"+menuData[i].id+"_anchor");
				var li = $(tag).find('i.jstree-themeicon');
					//.jstree-default,  background-position: -260px -4px;
					$(li).css('background-position', '-260px -36px');

					if(menuData[i].useYn == 'N'){
						//.jstree-er,  background-position:-36px -68px
						$(li).css('background-position', '-36px -68px');
					}
					else {
						//.jstree-default,  background-position: -260px -4px;
						$(li).css('background-position', '-260px -4px');
					}
			}
        }
	}
	
</script>

<div id="menuSelect-dialog" title="메뉴 선택">
	<input type="hidden" id="flag" />
	<div id="groupTree"  data-mcs-theme="dark-thin">
		<div id="treeBox" class="depth_container"></div>
	</div>
</div>
